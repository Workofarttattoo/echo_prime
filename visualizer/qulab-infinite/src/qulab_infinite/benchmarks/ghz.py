"""GHZ fidelity benchmark utilities."""

from __future__ import annotations

from dataclasses import dataclass
from typing import Dict, Optional, Union

import numpy as np
from qiskit import QuantumCircuit
from qiskit.quantum_info import DensityMatrix, Statevector, state_fidelity
from qiskit_aer import AerSimulator
from qiskit_aer.noise import NoiseModel

from qulab_infinite.validation.measurement import MeasurementRecord

def build_ghz_circuit(num_qubits: int) -> QuantumCircuit:
    if num_qubits < 2:
        raise ValueError("GHZ circuits require at least 2 qubits.")
    circuit = QuantumCircuit(num_qubits)
    circuit.h(0)
    for qubit in range(num_qubits - 1):
        circuit.cx(qubit, qubit + 1)
    return circuit


def ideal_ghz_state(num_qubits: int) -> Statevector:
    circuit = build_ghz_circuit(num_qubits)
    return Statevector.from_label("0" * num_qubits).evolve(circuit)


def simulate_state(
    num_qubits: int, noise_model: Optional[NoiseModel] = None
) -> Union[Statevector, DensityMatrix]:
    circuit = build_ghz_circuit(num_qubits)
    if noise_model is None:
        return Statevector.from_instruction(circuit)

    simulator = AerSimulator(method="density_matrix", noise_model=noise_model)
    result = simulator.run(circuit).result()
    rho = result.data(0)["density_matrix"]
    return DensityMatrix(rho)


def compute_fidelity(num_qubits: int, noise_model: Optional[NoiseModel] = None) -> float:
    target = ideal_ghz_state(num_qubits)
    trial = simulate_state(num_qubits, noise_model=noise_model)
    return float(state_fidelity(target, trial))


@dataclass
class GHZBenchmarkResult:
    fidelity: float
    sigma: float
    metadata: Dict[str, str]


def run_ghz_benchmark(
    num_qubits: int,
    *,
    iterations: int = 5,
    noise_model: Optional[NoiseModel] = None,
) -> GHZBenchmarkResult:
    samples = np.array([compute_fidelity(num_qubits, noise_model=noise_model) for _ in range(iterations)])
    return GHZBenchmarkResult(
        fidelity=float(samples.mean()),
        sigma=float(samples.std(ddof=1)) if iterations > 1 else 0.0,
        metadata={
            "qubits": str(num_qubits),
            "noise_model": "none" if noise_model is None else "custom",
            "iterations": str(iterations),
        },
    )


def build_measurement_record(
    result: GHZBenchmarkResult,
    *,
    dataset_id: str,
    datum_index: int,
) -> MeasurementRecord:
    """Convert a GHZ benchmark result into a MeasurementRecord instance."""
    return MeasurementRecord(
        dataset_id=dataset_id,
        datum_index=datum_index,
        quantity="ghz_state_fidelity",
        value=result.fidelity,
        unit="dimensionless",
        sigma=result.sigma,
        method="qiskit_ghz_benchmark",
        context_tags=result.metadata,
        citation="GHZ benchmark generated by Qulab Infinite tooling.",
        license="CC-BY-4.0",
    )
